#!/usr/bin/env bash

set -e

cwd="$(cd "$(dirname "$0")" && pwd)"
uri="git@github.com:boclips/backoffice.git"
private_key="$(bo show credential concourse-main boclips.backoffice repo-key)"
commit_with_149_version=870d3fd6bddc4d04f325e25b6eb3849f099e2565

input="$(
jq \
    --null-input \
    --arg uri "$uri" \
    --arg branch "$commit_with_149_version" \
    --arg private_key "$private_key" \
    '{
       source: {
         uri: $uri,
         branch: $branch,
         private_key: $private_key
       },
       version: {
         tag: "149"
       },
       params: {}
     }'
)"

expected_output="$(cat <<EOF
{
  "version": "149",
  "metadata": [
    {
      "name": "tag",
      "value": "149"
    }
  ]
}
EOF
)"

(
cd "$cwd/.."
image_id="$(docker build --quiet .)"
output="$(
docker run \
    --interactive \
    --entrypoint=/opt/resource/in \
    "$image_id" \
    <<< "$input"
)"

comparable_actual_output="$(jq <<< "$output")"
comparable_expected_output="$(jq <<< "$expected_output")"
if [ "$comparable_actual_output" == "$comparable_expected_output" ]
then
    echo "Test passed"
    exit 0
else
    echo "Test failed"
    echo
    echo "Expected output:"
    echo "$comparable_expected_output"
    echo
    echo "Actual output:"
    echo "$comparable_actual_output"
    echo
    exit 1
fi
)
