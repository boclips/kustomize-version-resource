#!/usr/bin/env bash

set -e

cwd="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1090
source "$cwd/common"

uri="git@github.com:boclips/backoffice.git"
private_key="$(bo show credential concourse-main boclips.backoffice repo-key)"
commit_with_149_version=870d3fd6bddc4d04f325e25b6eb3849f099e2565

input="$(
jq \
    --null-input \
    --arg uri "$uri" \
    --arg branch "$commit_with_149_version" \
    --arg private_key "$private_key" \
    '{
       source: {
         uri: $uri,
         branch: $branch,
         private_key: $private_key
       },
       version: {
         tag: "149"
       },
       params: {}
     }'
)"

expected_output="$(cat <<EOF
{
  "version": "149",
  "metadata": [
    {
      "name": "tag",
      "value": "149"
    }
  ]
}
EOF
)"

echo "in echoes version"
assert_equal_json \
    "$expected_output" \
    "$(run /opt/resource/in "$input")"
