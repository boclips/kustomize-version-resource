#!/usr/bin/env bash

set -e

cwd="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1090
source "$cwd/common"

payload="$(cat /dev/stdin)"

uri="$(get source uri <<< "$payload")"
private_key="$(get source private_key <<< "$payload")"
kustomization_yaml_path="$(get source kustomization_yaml_path <<< "$payload")"
[ "$kustomization_yaml_path" == null ] \
    && kustomization_yaml_path=k8s/base/kustomization.yaml
input_tag="$(get version tag <<< "$payload")"

clone "$uri" /tmp/repo "$private_key"
cd /tmp/repo
git pull --quiet

current_tag="$(
grep newTag "/tmp/repo/$kustomization_yaml_path" \
    | sed 's/.*newTag:[^0-9]*\([0-9]*\).*/\1/'
    )"
next_tag=$(( current_tag + 1 ))

jq \
    --null-input \
    "[range($input_tag;$next_tag) | { version: . | tostring }]"
