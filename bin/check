#!/usr/bin/env bash

set -e

cwd="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1090
source "$cwd/common"

payload="$(cat /dev/stdin)"
uri="$(get source uri <<< "$payload")"
branch="$(get source branch <<< "$payload")"
private_key="$(get source private_key <<< "$payload")"
kustomization_yaml_path="$(get source kustomization_yaml_path <<< "$payload")"
[ -z "$kustomization_yaml_path" ] \
    && kustomization_yaml_path=k8s/base/kustomization.yaml

if [ -z "$private_key" ]
then
    echo "Missing private key!"
    exit 1
fi

input_tag="$(get version tag <<< "$payload")"

clone "$uri" /tmp/repo "$branch" "$private_key"

current_tag="$("$cwd/parse-version" "/tmp/repo/$kustomization_yaml_path")"
next_tag=$(( current_tag + 1 ))

jq \
    --null-input \
    "[range($input_tag;$next_tag) | { version: . | tostring }]"
