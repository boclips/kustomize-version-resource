#!/usr/bin/env bash

set -e

cwd="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1090
source "$cwd/common"

declare -A config
parse_payload config "$(cat /dev/stdin)"
uri="${config['uri']}"
branch="${config['branch']}"
private_key="${config['private_key']}"
kustomization_yaml_path="${config['kustomization_yaml_path']}"
input_tag="${config['tag']}"

clone "$uri" /tmp/repo "$branch" "$private_key"

current_tag="$("$cwd/parse-version" "/tmp/repo/$kustomization_yaml_path")"
next_tag=$(( current_tag + 1 ))

jq \
    --null-input \
    "[range($input_tag;$next_tag) | { version: . | tostring }]"
