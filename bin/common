#!/usr/bin/env bash

get () {
    jq --raw-output ".$1.$2 // empty"
}

validate_payload () {
    payload=$1
    uri="$(get source uri <<< "$payload")"
    private_key="$(get source private_key <<< "$payload")"
    kustomization_yaml_path="$(get source kustomization_yaml_path <<< "$payload")"
    if [ -z "$uri" ] \
        || [ -z "$private_key" ] \
        || [ -z "$kustomization_yaml_path" ]
    then
        log "Must provide uri, private_key and kustomization_yaml_path"
        exit 1
    fi
}

clone () {
    uri="$1"
    destination="$2"
    branch="$3"
    private_key="$4"

    mkdir --parents ~/.ssh
    ssh-keyscan github.com \
        > ~/.ssh/known_hosts \
        2> /dev/null
    echo "$private_key" > ~/.ssh/id_rsa

    chmod 0400 ~/.ssh/id_rsa

    rm -rf "$destination"
    git clone --quiet "$uri" "$destination"
    git -C "$destination" checkout --quiet "$branch"
}

log () {
    >&2 echo "$@"
}
