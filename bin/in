#!/usr/bin/env bash

set -e

cwd="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1090
source "$cwd/common"

destination=$1
payload="$(cat /dev/stdin)"

input_tag="$(get version tag <<< "$payload")"
app="$(get version app <<< "$payload")"

echo "$input_tag" \
    > "$destination/tag"
echo "$app" \
    > "$destination/app"

jq \
    --null-input \
    --arg tag "$input_tag" \
    --arg app "$app" \
    '{ version: { tag: $tag, app: $app },
       metadata: [
         { name: "tag", value: $tag },
         { name: "app", value: $app }
       ] }'
