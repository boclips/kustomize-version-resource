#!/usr/bin/env bash

set -e

trigger_with_delay_seconds () {
    local limit=$1
    local delay=$2
    local path=$3
    (
    for n in $(seq 1 "$limit")
    do
        echo "trigger$n" > "$path"
        sleep "$delay"
    done
    ) &
}

cwd="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1090
source "$cwd/common"

export GIT_COMMITTER_NAME=Kustomizer
export GIT_COMMITTER_EMAIL=engineering@boclips.com

payload="$(cat)"
push="$cwd/push"
try_limit=5

validate_payload "$payload"

resources_root=$1

uri="$(get source uri <<< "$payload")"
private_key="$(get source private_key <<< "$payload")"
kustomization_yaml_path="$(get source kustomization_yaml_path <<< "$payload")"
version_file="$(get params file <<< "$payload")"
version="$(cat "$resources_root/$version_file")"
clone_dir=/tmp/repo

clone "$uri" "$clone_dir" "$private_key"

app="$("$cwd/parse-app" "$clone_dir/$kustomization_yaml_path")"

cd "$clone_dir/$(dirname "$kustomization_yaml_path")"

kustomize edit set image "app=eu.gcr.io/boclips-prod/boclips/$app:$version"
kustomize edit add annotation --force "boclips-version:$version"

git \
  commit \
  --quiet \
  --all \
  --author="$GIT_COMMITTER_NAME <$GIT_COMMITTER_EMAIL>" \
  --message="Bump $app version to $version"

pipe_path=/tmp/push_pipe
mkfifo "$pipe_path"

trigger_with_delay_seconds "$try_limit" 1 "$pipe_path"

$push "$clone_dir" "$pipe_path" "$try_limit"

jq \
    --null-input \
    --arg tag "$version" \
    --arg app "$app" \
    '{
       version: { tag: $tag, app: $app },
       metadata: [{ name: "tag", value: $tag }, { name: "app", value: $app }]
     }'
