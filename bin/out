#!/usr/bin/env bash

set -e

cwd="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1090
source "$cwd/common"

export GIT_COMMITTER_NAME=Kustomizer
export GIT_COMMITTER_EMAIL=engineering@boclips.com

declare -A config
parse_payload config "$(cat /dev/stdin)"

uri="${config['uri']}"
branch="${config['branch']}"
private_key="${config['private_key']}"
kustomization_yaml_path="${config['kustomization_yaml_path']}"

clone "$uri" /tmp/repo "$branch" "$private_key"

cd /tmp/repo

current_version="$("$cwd/parse-version" "$kustomization_yaml_path")"
app="$("$cwd/parse-app" "$kustomization_yaml_path")"
bumped_version=$(( current_version + 1 ))

cd "$(dirname "$kustomization_yaml_path")"

kustomize edit set image "app=eu.gcr.io/boclips-prod/boclips/$app:$bumped_version"
kustomize edit add annotation --force "boclips-version:$bumped_version"

git \
  commit \
  --quiet \
  --all \
  --author="$GIT_COMMITTER_NAME <$GIT_COMMITTER_EMAIL>" \
  --message="$(cat <<EOF
Bump version to $bumped_version

[ci skip]
EOF
)"

git push --quiet

jq \
    --null-input \
    --arg tag "$bumped_version" \
    '{ version: { tag: $tag }, metadata: [{ name: "tag", value: $tag }] }'
