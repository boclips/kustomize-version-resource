#!/usr/bin/env bash

set -e

cwd="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1090
source "$cwd/common"

export GIT_COMMITTER_NAME=Kustomizer
export GIT_COMMITTER_EMAIL=engineering@boclips.com

declare -A config
parse_payload config "$(cat /dev/stdin)"

uri="${config['uri']}"
branch="${config['branch']}"
private_key="${config['private_key']}"
kustomization_yaml_path="${config['kustomization_yaml_path']}"
version="$(cat "${config['file']}")"
clone_dir=/tmp/repo

clone "$uri" "$clone_dir" "$branch" "$private_key"

app="$("$cwd/parse-app" "$clone_dir/$kustomization_yaml_path")"

cd "$clone_dir/$(dirname "$kustomization_yaml_path")"

kustomize edit set image "app=eu.gcr.io/boclips-prod/boclips/$app:$version"
kustomize edit add annotation --force "boclips-version:$version"

git \
  commit \
  --quiet \
  --all \
  --author="$GIT_COMMITTER_NAME <$GIT_COMMITTER_EMAIL>" \
  --message="Bump $app version to $version"

git push --quiet

jq \
    --null-input \
    --arg tag "$version" \
    --arg app "$app" \
    '{
       version: { tag: $tag, app: $app },
       metadata: [{ name: "tag", value: $tag }, { name: "app", value: $app }]
     }'
